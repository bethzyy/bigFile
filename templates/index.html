<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§ßÊñá‰ª∂‰º†ËæìÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border: none;
            background: none;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #eef2ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #eef2ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            color: #667eea;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .progress-container {
            margin-top: 30px;
            display: none;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
        }

        .progress-bar-bg {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .file-list {
            margin-top: 30px;
        }

        .file-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .file-meta {
            color: #6c757d;
            font-size: 0.9em;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .uploading {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Â§ßÊñá‰ª∂‰º†ËæìÁ≥ªÁªü</h1>
            <p>ÊîØÊåÅ >10GB Êñá‰ª∂ÁöÑÈ´òÈÄü‰º†Ëæì | ÂàÜÁâá‰∏ä‰º† | Êñ≠ÁÇπÁª≠‰º†</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">üì§ ‰∏ä‰º†Êñá‰ª∂</button>
            <button class="tab" onclick="switchTab('download')">üì• ‰∏ãËΩΩÊñá‰ª∂</button>
        </div>

        <div id="upload-tab" class="tab-content active">
            <div id="uploadAlert"></div>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÅ</div>
                <h3>ÁÇπÂáªÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ</h3>
                <p style="color: #6c757d; margin-top: 10px;">ÊîØÊåÅ‰ªªÊÑèÂ§ßÂ∞èÊñá‰ª∂,Ëá™Âä®ÂàÜÁâá‰∏ä‰º†</p>
                <input type="file" id="fileInput" class="file-input" onchange="handleFileSelect(event)">
            </div>

            <div class="progress-container" id="uploadProgress">
                <div class="progress-info">
                    <span id="uploadFileName">Êñá‰ª∂Âêç</span>
                    <span id="uploadPercentage">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar" id="uploadProgressBar" style="width: 0%">0%</div>
                </div>
                <div class="progress-info" style="margin-top: 10px;">
                    <span id="uploadSpeed">ÈÄüÂ∫¶: 0 MB/s</span>
                    <span id="uploadTime">Ââ©‰ΩôÊó∂Èó¥: ËÆ°ÁÆó‰∏≠...</span>
                </div>
            </div>
        </div>

        <div id="download-tab" class="tab-content">
            <div id="downloadAlert"></div>

            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalFiles">0</div>
                    <div class="stat-label">ÊÄªÊñá‰ª∂Êï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSize">0 GB</div>
                    <div class="stat-label">ÊÄªÂ§ßÂ∞è</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="loadFileList()">üîÑ Âà∑Êñ∞Êñá‰ª∂ÂàóË°®</button>
            </div>

            <div class="file-list" id="fileList">
                <p style="text-align: center; color: #6c757d;">Âä†ËΩΩ‰∏≠...</p>
            </div>
        </div>
    </div>

    <script>
        const CHUNK_SIZE = 100 * 1024 * 1024; // 100MB
        let uploadId = null;
        let startTime = null;

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'upload') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('upload-tab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('download-tab').classList.add('active');
                loadFileList();
            }
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            const activeAlert = document.querySelector('.tab-content.active .alert');
            if (activeAlert) {
                activeAlert.parentNode.removeChild(activeAlert);
            }

            document.querySelector('.tab-content.active').insertBefore(
                alertDiv,
                document.querySelector('.tab-content.active').firstChild
            );

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ‰∏ä‰º†Áõ∏ÂÖ≥
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadFile(file);
            }
        }

        async function uploadFile(file) {
            try {
                document.getElementById('uploadProgress').style.display = 'block';
                document.getElementById('uploadFileName').textContent = file.name;
                startTime = Date.now();

                // ÂàùÂßãÂåñ‰∏ä‰º†
                const initRes = await fetch('/api/upload/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        filesize: file.size,
                        file_hash: '' // ÂèØÈÄâ:Ê∑ªÂä†Êñá‰ª∂ÂìàÂ∏åÊ†°È™å
                    })
                });

                const initData = await initRes.json();
                if (!initData.success) {
                    throw new Error(initData.error);
                }

                uploadId = initData.upload_id;
                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

                // ‰∏ä‰º†ÂàÜÁâá
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, file.size);
                    const chunk = file.slice(start, end);

                    const formData = new FormData();
                    formData.append('upload_id', uploadId);
                    formData.append('chunk_index', i);
                    formData.append('total_chunks', totalChunks);
                    formData.append('chunk', chunk);

                    const chunkRes = await fetch('/api/upload/chunk', {
                        method: 'POST',
                        body: formData
                    });

                    const chunkData = await chunkRes.json();
                    if (!chunkData.success) {
                        throw new Error(chunkData.error);
                    }

                    // Êõ¥Êñ∞ËøõÂ∫¶
                    const progress = ((i + 1) / totalChunks * 100).toFixed(2);
                    updateProgress(progress, chunkData.uploaded, chunkData.total);
                }

                // ÂÆåÊàê‰∏ä‰º†
                const completeRes = await fetch('/api/upload/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ upload_id: uploadId })
                });

                const completeData = await completeRes.json();
                if (!completeData.success) {
                    throw new Error(completeData.error);
                }

                showAlert('success', `‚úÖ Êñá‰ª∂ "${file.name}" ‰∏ä‰º†ÊàêÂäü!`);
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('fileInput').value = '';

            } catch (error) {
                showAlert('error', `‚ùå ‰∏ä‰º†Â§±Ë¥•: ${error.message}`);
                document.getElementById('uploadProgress').style.display = 'none';
            }
        }

        function updateProgress(percentage, uploaded, total) {
            document.getElementById('uploadProgressBar').style.width = percentage + '%';
            document.getElementById('uploadProgressBar').textContent = percentage + '%';
            document.getElementById('uploadPercentage').textContent = percentage + '%';

            // ËÆ°ÁÆóÈÄüÂ∫¶
            const elapsed = (Date.now() - startTime) / 1000;
            const speed = uploaded / elapsed;
            document.getElementById('uploadSpeed').textContent = `ÈÄüÂ∫¶: ${formatSize(speed)}/s`;

            // ËÆ°ÁÆóÂâ©‰ΩôÊó∂Èó¥
            const remaining = (total - uploaded) / speed;
            document.getElementById('uploadTime').textContent =
                `Ââ©‰ΩôÊó∂Èó¥: ${Math.floor(remaining / 60)}ÂàÜ${Math.floor(remaining % 60)}Áßí`;
        }

        // ‰∏ãËΩΩÁõ∏ÂÖ≥
        async function loadFileList() {
            try {
                const res = await fetch('/api/list');
                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                displayFileList(data.files);
            } catch (error) {
                showAlert('error', `‚ùå Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•: ${error.message}`);
            }
        }

        function displayFileList(files) {
            const fileList = document.getElementById('fileList');

            if (files.length === 0) {
                fileList.innerHTML = '<p style="text-align: center; color: #6c757d;">ÊöÇÊó†Êñá‰ª∂</p>';
                document.getElementById('totalFiles').textContent = '0';
                document.getElementById('totalSize').textContent = '0 GB';
                return;
            }

            let totalSize = 0;
            let html = '';

            files.forEach(file => {
                totalSize += file.size;

                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">üìÑ ${file.name}</div>
                            <div class="file-meta">
                                Â§ßÂ∞è: ${file.size_human} |
                                ‰øÆÊîπÊó∂Èó¥: ${file.modified}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-primary" onclick="downloadFile('${file.path}')">
                                ‚¨áÔ∏è ‰∏ãËΩΩ
                            </button>
                            <button class="btn btn-danger" onclick="deleteFile('${file.path}')">
                                üóëÔ∏è Âà†Èô§
                            </button>
                        </div>
                    </div>
                `;
            });

            fileList.innerHTML = html;
            document.getElementById('totalFiles').textContent = files.length;
            document.getElementById('totalSize').textContent = formatSize(totalSize);
        }

        function downloadFile(filepath) {
            window.location.href = `/api/download/${filepath}`;
        }

        async function deleteFile(filepath) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êñá‰ª∂Âêó?')) {
                return;
            }

            try {
                const res = await fetch(`/api/delete/${filepath}`, {
                    method: 'DELETE'
                });

                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                showAlert('success', '‚úÖ Êñá‰ª∂Â∑≤Âà†Èô§');
                loadFileList();
            } catch (error) {
                showAlert('error', `‚ùå Âà†Èô§Â§±Ë¥•: ${error.message}`);
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®Âä†ËΩΩÊñá‰ª∂ÂàóË°®
        window.onload = () => {
            loadFileList();
        };
    </script>
</body>
</html>
